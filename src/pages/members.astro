---
import Layout from '../layouts/Layout.astro';
import TeamSection from '../components/TeamSection.astro';
import { getPageBySlug } from '../lib/wordpress';
import type { MemberWpData } from '../types/member';

// Fetch the members page content from WordPress
let pageContent = '';
let pageTitle = '';
try {
  const page = await getPageBySlug('members');
  pageContent = page?.content?.rendered || '';
  pageTitle = page?.title?.rendered || '';
} catch (error) {
  console.error("Error fetching members page content:", error);
}

// Fetch members from WordPress
let members: any[] = [];
try {
  const perPage = 100;
  const firstPage = await fetch(`https://acrooc.com/wp-json/wp/v2/posts?per_page=${perPage}`);
  const totalPages = parseInt(firstPage.headers.get('X-WP-TotalPages') || '1');
  
  // Get first page of data
  let data = await firstPage.json();
  
  // Get remaining pages if any
  for(let page = 2; page <= totalPages; page++) {
    const res = await fetch(`https://acrooc.com/wp-json/wp/v2/posts?per_page=${perPage}&page=${page}`);
    const moreData = await res.json();
    data = [...data, ...moreData];
  }
  members = data.map((member: MemberWpData) => ({
    name: member.acf.name,
    title: member.acf.title,
    image: member.acf.image,
    affiliations: member.acf.affiliations,
    bio: member.acf.bio
  }));
  members = members.filter(member => member.affiliations && !(member.affiliations || '').toLowerCase().includes('(draft)')); // Only include members with non-draft affiliations
} catch (error) {
  console.error("Error fetching members:", error);
}
---

<Layout title={`${pageTitle} - Corporate Directors Roundtable of Orange County`}>
  <div class="cdroc-row">
    <div class="cdroc-col">
      <h1 set:html={pageTitle} /> 
      <div class="members-intro wp-content" set:html={pageContent} />
      <TeamSection members={members} />
    </div>
  </div>
</Layout>

<style>
  .members-intro {
    margin: 2rem 0;
    line-height: 1.6;
    color: #494949;
    font-weight: normal;
  }
</style> 