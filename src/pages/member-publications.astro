---
import Layout from '../layouts/Layout.astro';
import PublicationsSection from '../components/PublicationsSection.astro';
import { getPageBySlug, PUBLICATION_CATEGORIES } from '../lib/wordpress';
import type { PublicationWpData } from '../types/member';

// Fetch the publications page content from WordPress
let pageContent = '';
let pageTitle = '';
try {
  const page = await getPageBySlug('member-publications');
  pageContent = page?.content?.rendered || '';
  pageTitle = page?.title?.rendered || '';
} catch (error) {
  console.error("Error fetching publications page content:", error);
}

// Helper function to decode HTML entities
function decodeHtmlEntities(text: string): string {
  const htmlEntities: { [key: string]: string } = {
    '&#8217;': "'",
    '&#8216;': "'",
    '&#8220;': '"',
    '&#8221;': '"',
    '&#8211;': '–',
    '&#8212;': '—',
    '&#8230;': '…',
    '&amp;': '&',
    '&lt;': '<',
    '&gt;': '>',
    '&quot;': '"',
    '&apos;': "'",
    '&nbsp;': ' '
  };
  
  return text.replace(/&#?\w+;/g, (entity) => {
    return htmlEntities[entity] || entity;
  });
}

// Fetch publications from WordPress
let publications: any[] = [];
try {
  const perPage = 100;
  // Filter by category 'Publication' for efficiency
  const firstPage = await fetch(`https://acrooc.com/wp-json/wp/v2/posts?per_page=${perPage}&categories=${PUBLICATION_CATEGORIES.join(',')}`);
  const totalPages = parseInt(firstPage.headers.get('X-WP-TotalPages') || '1');
  
  // Get first page of data
  let data = await firstPage.json();

  // Get remaining pages if any
  for(let page = 2; page <= totalPages; page++) {
    const res = await fetch(`https://acrooc.com/wp-json/wp/v2/posts?per_page=${perPage}&page=${page}&categories=${PUBLICATION_CATEGORIES.join(',')}`);
    const moreData = await res.json();
    data = [...data, ...moreData];
  }
  publications = data.map((publication: PublicationWpData) => ({
    title: decodeHtmlEntities(publication.title.rendered),
    author: publication.acf.author,
    publication_url: publication.acf.publication_url,
    thumbnail: publication.acf.thumbnail,
    categories: publication.categories,
    publication_date: publication.acf.publication_date,
    publication_date_use_exact_day: publication.acf.publication_date_use_exact_day,
  }));
} catch (error) {
  console.error("Error fetching publications:", error);
}
---

<Layout title={`${pageTitle} - Corporate Directors Roundtable of Orange County`}>
  <div class="cdroc-row">
    <div class="cdroc-col">
      <h1 set:html={pageTitle} /> 
      <div class="publications-intro wp-content" set:html={pageContent} />
      <PublicationsSection publications={publications} />
    </div>
  </div>
</Layout>

<style>
  .publications-intro {
    margin: 2rem 0;
    line-height: 1.6;
    color: #494949;
    font-weight: normal;
  }
</style>
