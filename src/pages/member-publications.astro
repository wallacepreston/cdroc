---
import Layout from '../layouts/Layout.astro';
import PublicationsSection from '../components/PublicationsSection.astro';
import { getPageBySlug, CATEGORY_IDS } from '../lib/wordpress';
import type { PublicationWpData } from '../types/member';

// Fetch the publications page content from WordPress
let pageContent = '';
let pageTitle = '';
try {
  const page = await getPageBySlug('member-publications');
  pageContent = page?.content?.rendered || '';
  pageTitle = page?.title?.rendered || '';
} catch (error) {
  console.error("Error fetching publications page content:", error);
}

// Fetch publications from WordPress
let publications: any[] = [];
try {
  const perPage = 100;
  // Filter by category 'Publication' for efficiency
  const firstPage = await fetch(`https://acrooc.com/wp-json/wp/v2/posts?per_page=${perPage}&categories=${CATEGORY_IDS.PUBLICATION}`);
  const totalPages = parseInt(firstPage.headers.get('X-WP-TotalPages') || '1');
  
  // Get first page of data
  let data = await firstPage.json();

  // Get remaining pages if any
  for(let page = 2; page <= totalPages; page++) {
    const res = await fetch(`https://acrooc.com/wp-json/wp/v2/posts?per_page=${perPage}&page=${page}&categories=${CATEGORY_IDS.PUBLICATION}`);
    const moreData = await res.json();
    data = [...data, ...moreData];
  }
  publications = data.map((publication: PublicationWpData) => ({
    title: publication.title.rendered,
    author: publication.acf.author,
    publication_url: publication.acf.publication_url,
    thumbnail: publication.acf.thumbnail,
    categories: publication.categories,
  }));
} catch (error) {
  console.error("Error fetching publications:", error);
}
---

<Layout title={`${pageTitle} - Corporate Directors Roundtable of Orange County`}>
  <div class="cdroc-row">
    <div class="cdroc-col">
      <h1 set:html={pageTitle} /> 
      <div class="publications-intro wp-content" set:html={pageContent} />
      <PublicationsSection publications={publications} />
    </div>
  </div>
</Layout>

<style>
  .publications-intro {
    margin: 2rem 0;
    line-height: 1.6;
    color: #494949;
    font-weight: normal;
  }
</style>
